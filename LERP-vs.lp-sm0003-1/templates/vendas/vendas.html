{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
  <h3 class="text-primary">üõç Nova Venda</h3>
  <form method="post">
    <table class="table table-bordered mt-3">
      <thead class="table-dark">
        <tr>
          <th>#</th>
          <th>C√≥digo</th>
          <th>Produto</th>
          <th>Pre√ßo Unit√°rio</th>
          <th>Stock</th>
          <th>Quantidade</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
        {% for p in produtos %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>{{ p.codigo }}</td>
          <td>{{ p.nome }}</td>
          <td>{{ "%.2f"|format(p.preco_unitario) }} MT</td>
          <td>{{ p.stock }}</td>
          <td>
            <input type="number" name="quant_{{ p.codigo }}" class="form-control" min="0" max="{{ p.stock }}" value="0" onchange="calcularTotal()">
          </td>
          <td class="valor-item">0.00 MT</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="text-end mt-3">
      <h4>Total Geral: <span id="total-geral">0.00</span> MT</h4>
    </div>

    <div class="mt-3">
      <button type="submit" class="btn btn-success">üí≥ Pagar</button>
      <a href="{{ url_for('vendas.lista_vendas') }}" class="btn btn-secondary">Cancelar</a>
    </div>
  </form>
</div>

<script>
function calcularTotal() {
  let linhas = document.querySelectorAll("tbody tr");
  let totalGeral = 0;
  linhas.forEach(linha => {
    let preco = parseFloat(linha.children[3].innerText.replace(" MT",""));
    let qtd = parseFloat(linha.querySelector("input").value);
    let total = preco * qtd;
    linha.querySelector(".valor-item").innerText = total.toFixed(2) + " MT";
    totalGeral += total;
  });
  document.getElementById("total-geral").innerText = totalGeral.toFixed(2);
}
</script>
{% endblock %}
