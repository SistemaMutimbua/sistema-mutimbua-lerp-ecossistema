{% extends "base.html" %}
{% block title %}Nova Venda{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="fw-bold mb-4">游 Nova Venda</h2>

    <!-- Formul치rio de busca de produtos -->
    <div class="row mb-3">
        <div class="col-md-7 position-relative">
            <input type="text" id="produtoInput" class="form-control" placeholder="Digite nome ou c칩digo do produto...">
            <div id="autocompleteList" class="list-group position-absolute w-100" style="z-index:1000;"></div>
        </div>
        <div class="col-md-2">
            <input type="number" id="quantidadeInput" class="form-control" min="1" value="1">
        </div>
        <div class="col-md-3">
            <button type="button" class="btn btn-success w-100" id="btnAdicionar">
                Adicionar <i class="bi bi-cart-plus-fill"></i>
            </button>
        </div>
    </div>

    <!-- Carrinho -->
    <div class="table-responsive shadow-sm rounded">
        <table class="table table-hover align-middle" id="tabelaCarrinho">
            <thead class="table-dark">
                <tr>
                    <th>#</th>
                    <th>Produto</th>
                    <th>Quantidade</th>
                    <th>Pre칞o Unit치rio (MT)</th>
                    <th>Subtotal (MT)</th>
                    <th>A칞칚o</th>
                </tr>
            </thead>
            <tbody>
                {% for item in itens %}
                <tr data-id="{{ item.codigo }}">
                    <td>{{ loop.index }}</td>
                    <td>{{ item.nome }}</td>
                    <td><input type="number" min="1" value="{{ item.quantidade }}" class="form-control quantidade" style="width:80px;"></td>
                    <td>{{ "%.2f"|format(item.preco) }}</td>
                    <td class="subtotal text-success fw-bold">{{ "%.2f"|format(item.subtotal) }}</td>
                    <td>
                        <button class="btn btn-outline-danger btn-sm remover">
                            <i class="bi bi-trash-fill"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Total e finalizar -->
    <div class="d-flex justify-content-between align-items-center mt-3">
        <h5>Total: <span id="totalVenda">0.00</span> MT</h5>
        <form id="finalizarForm" action="{{ url_for('vendas.finalizar_venda') }}" method="POST">
            <button type="submit" class="btn btn-primary btn-lg" id="btnFinalizar" {% if not itens %}disabled{% endif %}>
                Finalizar Venda <i class="bi bi-credit-card-fill ms-1"></i>
            </button>
        </form>
    </div>

    <!-- Toasts Bootstrap -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
        <div id="toastContainer"></div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    let carrinho = [];

    // Inicializa carrinho do template
    {% for item in itens %}
    carrinho.push({
        produto_id: "{{ item.codigo }}",
        nome: "{{ item.nome }}",
        preco_unitario: {{ item.preco }},
        quantidade: {{ item.quantidade }}
    });
    {% endfor %}

    // Toast
    function showToast(mensagem, tipo="success") {
        const container = document.getElementById("toastContainer");
        const toast = document.createElement("div");
        toast.className = `toast align-items-center text-bg-${tipo} border-0`;
        toast.setAttribute("role", "alert");
        toast.setAttribute("aria-live", "assertive");
        toast.setAttribute("aria-atomic", "true");
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${mensagem}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
        container.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        toast.addEventListener('hidden.bs.toast', () => toast.remove());
    }

    // Atualiza tabela
    function atualizarCarrinho() {
        const tbody = document.querySelector("#tabelaCarrinho tbody");
        tbody.innerHTML = "";
        let total = 0;

        carrinho.forEach((item, index) => {
            const subtotal = item.preco_unitario * item.quantidade;
            total += subtotal;

            const tr = document.createElement("tr");
            tr.dataset.id = item.produto_id;
            tr.innerHTML = `
                <td>${index + 1}</td>
                <td>${item.nome}</td>
                <td><input type="number" min="1" value="${item.quantidade}" class="form-control quantidade" style="width:80px;"></td>
                <td>${item.preco_unitario.toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
                <td class="subtotal text-success fw-bold">${subtotal.toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
                <td>
                    <button class="btn btn-outline-danger btn-sm remover">
                        <i class="bi bi-trash-fill"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);

            // Remover item
            tr.querySelector(".remover").addEventListener("click", () => {
                carrinho = carrinho.filter(i => i.produto_id != item.produto_id);
                atualizarCarrinho();
            });

            // Alterar quantidade
            tr.querySelector(".quantidade").addEventListener("input", (e) => {
                item.quantidade = parseInt(e.target.value) || 1;
                atualizarCarrinho();
            });
        });

        document.getElementById("totalVenda").innerText = total.toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2});
        document.getElementById("btnFinalizar").disabled = carrinho.length === 0;
    }

    // Autocomplete produtos
    const produtoInput = document.getElementById("produtoInput");
    const autocompleteList = document.getElementById("autocompleteList");

    produtoInput.addEventListener("input", async () => {
        const termo = produtoInput.value.trim();
        if (!termo) {
            autocompleteList.innerHTML = "";
            return;
        }

        const resp = await fetch(`/vendas/buscar_produtos?q=${encodeURIComponent(termo)}`);
        const produtos = await resp.json();

        autocompleteList.innerHTML = "";
        produtos.forEach(p => {
            const item = document.createElement("a");
            item.href = "#";
            item.className = "list-group-item list-group-item-action";
            item.textContent = `${p.nome} (${p.codigo}) - ${p.preco.toLocaleString('pt-BR', {minimumFractionDigits:2})} MT`;
            item.dataset.id = p.id;
            item.dataset.nome = p.nome;
            item.dataset.preco = p.preco;

            item.addEventListener("click", (e) => {
                e.preventDefault();
                produtoInput.value = p.nome;
                produtoInput.dataset.id = p.id;
                produtoInput.dataset.preco = p.preco;
                autocompleteList.innerHTML = "";
            });

            autocompleteList.appendChild(item);
        });
    });

    // Adicionar produto ao carrinho
    document.getElementById("btnAdicionar").addEventListener("click", () => {
        const id = produtoInput.dataset.id;
        const nome = produtoInput.value;
        const preco = parseFloat(produtoInput.dataset.preco || 0);
        const quantidade = parseInt(document.getElementById("quantidadeInput").value) || 1;

        if (!id || !nome || preco <= 0) {
            showToast("Selecione um produto v치lido.", "danger");
            return;
        }

        const existente = carrinho.find(i => i.produto_id == id);
        if (existente) {
            existente.quantidade += quantidade;
        } else {
            carrinho.push({produto_id: id, nome, preco_unitario: preco, quantidade});
        }

        // Limpar input
        produtoInput.value = "";
        delete produtoInput.dataset.id;
        delete produtoInput.dataset.preco;
        document.getElementById("quantidadeInput").value = 1;

        atualizarCarrinho();
    });

    atualizarCarrinho();
});
</script>
{% endblock %}
